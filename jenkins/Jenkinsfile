pipeline {
    agent {
        label 'ahmad-node'  # Explicitly use ahmad-node
    }
    
    stages {
        stage('Check Node') {
            steps {
                sh '''
                    echo "========================================"
                    hostname
                    echo "Running on: $(hostname)"
                    echo "This is AHMAD's node (ahmad-node)"
                    echo "Using OpenStack credentials"
                    echo "========================================"
                '''
            }
        }
        
        stage('Checkout') {
            steps {
                checkout scm
                sh 'echo "Repository: https://github.com/ags1995/infra-terraform-yc.git"'
            }
        }
        
        stage('Setup Environment') {
            steps {
                sh '''
                    echo "Setting up environment..."
                    # OpenStack credentials should be set as environment variables in Jenkins
                    # or in the node's ~/.bashrc
                '''
            }
        }
        
        stage('Terraform Apply') {
            steps {
                dir('terraform') {
                    sh '''
                        set -e
                        echo "Initializing Terraform for OpenStack..."
                        terraform init
                        
                        echo "Applying Terraform configuration..."
                        terraform apply -auto-approve \
                            -var="image_name=ubuntu-20.04" \
                            -var="flavor_name=m1.small" \
                            -var="network_name=students-net" \
                            -var="keypair=jenkins-key"
                        
                        echo "Extracting VM IP..."
                        terraform output -raw vm_ip > ../ansible/ip.txt
                        echo "VM IP: $(cat ../ansible/ip.txt)"
                    '''
                }
            }
        }
        
        stage('Wait for SSH') {
            steps {
                dir('ansible') {
                    sh '''
                        set -e
                        VM_IP=$(cat ip.txt)
                        echo "Waiting for SSH on $VM_IP..."
                        
                        # Wait up to 2 minutes for SSH
                        timeout=120
                        while ! nc -z $VM_IP 22; do
                            sleep 5
                            timeout=$((timeout-5))
                            if [ $timeout -le 0 ]; then
                                echo "Timeout waiting for SSH"
                                exit 1
                            fi
                            echo "Still waiting... ($timeout seconds remaining)"
                        done
                        
                        echo "SSH is ready on $VM_IP"
                    '''
                }
            }
        }
        
        stage('Deploy with Ansible') {
            steps {
                dir('ansible') {
                    sh '''
                        set -e
                        VM_IP=$(cat ip.txt)
                        
                        echo "Creating Ansible inventory..."
                        cat > inventory.ini << EOL
[servers]
vm ansible_host=$VM_IP ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/jenkins_deploy_rsa
EOL
                        
                        echo "Inventory created:"
                        cat inventory.ini
                        
                        echo "Running Ansible playbook..."
                        ansible-playbook -i inventory.ini \
                            --ssh-common-args="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
                            playbook.yml
                    '''
                }
            }
        }
        
        stage('Verification') {
            steps {
                sh '''
                    echo "=== Pipeline Verification ==="
                    echo "✅ Terraform deployment complete"
                    echo "✅ Ansible configuration applied"
                    echo "✅ Pipeline finished successfully"
                    echo "=============================="
                '''
            }
        }
        
        stage('Cleanup') {
            steps {
                sh '''
                    echo "Cleaning up temporary files..."
                    # Keep infrastructure running for verification
                    echo "Infrastructure remains running"
                '''
            }
        }
    }
    
    post {
        always {
            echo "=== Pipeline Execution Complete ==="
        }
        success {
            echo "✅ Pipeline succeeded!"
        }
        failure {
            echo "❌ Pipeline failed!"
        }
    }
}
